#!/usr/bin/env bash
# Enterprise QtScrcpy Development Environment
# Multi-shell architecture with intelligent loading

# Use nix-direnv for better caching and performance
if ! has nix_direnv_version || ! nix_direnv_version 3.0.4; then
  source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/3.0.4/direnvrc" "sha256-DzlYZ33mWF/Gs8DDeyjr8mnVmQGx7ASYqA5WlxwvBG4="
fi

# Environment detection and switching logic
detect_shell_type() {
  # Check environment variables for shell preference
  if [[ "${QTSCRCPY_ENV:-}" == "full" ]]; then
    echo "full"
  elif [[ "${QTSCRCPY_ENV:-}" == "qt" ]]; then
    echo "qt"
  elif [[ "${QTSCRCPY_ENV:-}" == "android" ]]; then
    echo "android"
  elif [[ -f ".qtscrcpy-env" ]]; then
    # Check for project-specific environment file
    cat .qtscrcpy-env
  else
    # Default to minimal for fast startup
    echo "default"
  fi
}

# Load the appropriate development shell
SHELL_TYPE=$(detect_shell_type)

case "$SHELL_TYPE" in
  "full")
    echo "ðŸš€ Loading COMPLETE QtScrcpy environment..."
    echo "âš ï¸  This may take 30-60 seconds for initial load"
    echo "ðŸ“¦ Includes: Qt6 + Android SDK + Multimedia + Debug tools"
    use flake .#full --impure
    ;;
  
  "qt")
    echo "ðŸŽ¨ Loading Qt6 development environment..."
    echo "â±ï¸  Loading time: ~10-15 seconds"
    echo "ðŸ“¦ Includes: Qt6 + Graphics + Build tools"
    use flake .#qt --impure
    ;;
  
  "android")
    echo "ðŸ“± Loading Android development environment..."
    echo "â±ï¸  Loading time: ~15-20 seconds"  
    echo "ðŸ“¦ Includes: Android SDK + ADB + Build tools"
    use flake .#android --impure
    ;;
  
  "default"|*)
    echo "âš¡ Loading MINIMAL QtScrcpy environment..."
    echo "â±ï¸  Loading time: ~3-5 seconds"
    echo "ðŸ“¦ Includes: Core tools + CMake + Git"
    use flake . --impure  # Uses default shell
    ;;
esac

# Post-load information and commands
echo ""
echo "ðŸ”§ Environment switching commands:"
echo "  echo 'qt' > .qtscrcpy-env && direnv reload      # Qt6 development"
echo "  echo 'android' > .qtscrcpy-env && direnv reload # Android tools"
echo "  echo 'full' > .qtscrcpy-env && direnv reload    # Complete environment"
echo "  echo 'default' > .qtscrcpy-env && direnv reload # Back to minimal"
echo ""
echo "ðŸš€ Or use environment variables:"
echo "  QTSCRCPY_ENV=qt direnv reload     # Temporary Qt6 environment"
echo "  QTSCRCPY_ENV=full direnv reload   # Temporary full environment"
echo ""

if [[ "$SHELL_TYPE" == "default" ]]; then
  echo "ðŸ’¡ Current: Minimal environment"
  echo "ðŸ“š Available shells:"
  echo "   nix develop .#qt      - Qt6 development"
  echo "   nix develop .#android - Android tools"
  echo "   nix develop .#full    - Complete environment"
  echo ""
  echo "ðŸ—ï¸  Quick start:"
  echo "   1. Set environment: echo 'qt' > .qtscrcpy-env && direnv reload"
  echo "   2. Build project: build_debug"
  echo "   3. Run application: run_qtscrcpy"
fi

# Performance optimization: cache direnv layout
export DIRENV_LOG_FORMAT=